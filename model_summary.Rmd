---
title: "_The Economist_'s Presidential Election Forecasting Model"
subtitle: "Model designed in collaboration with Merlin Heidemanns and Andrew Gelman (Columbia University)"
output: html_document
---

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Methodology

Our forecasting model produces predictions for Democratic and Republican two-party vote share at the state and national level for every day in the election campaign. This section describes the method with which it arrives at those predictions. 

Following the model description is a summary of how the method performed in the 2008, 2012 and 2016 presidential elections. 

### Structure

It is useful to think of the model as a combination of pre-election polls with other data about election outcomes, sometimes referred to as the "fundamentals" of the campaign. These data translate the president's popularity and the economic environment into long-range forecasts of the final election outcome, made as early as March and updated throughout the election year. In the Bayesian sense, the model is using state and national polls to update these prior expectations of the political environment. 

We are interested not only in the precise vote-share predictions from the model, but also the level of certainty we do(n't) have in them. The model is thus made up of three different conceptual components:

1. Prior predictions
2. Polling averages
3. Exploration of uncertainty

The first two are easier to explain than the latter. But before we get there, let's address what data the model is ingesting.

### Data

TK
Prior: Head-to-heads + economic index throughout the election year
Polls: Well, polls :)

### Prior

TK

### Poll averaging

TK

### Uncertianty (or, how wrong could we be?)

TK


## Model performance

Overall:

### 2008

```{r include = F}
# will read in the most recent back-test for 2008
out  <- read_rds(sprintf('models/backtest_2008/stan_model_%s.rds',RUN_DATE))

# etc
a <- rstan::extract(out, pars = "alpha")[[1]]
hist(a)
# sigmas
tibble(sigma_national = rstan::extract(out, pars = "sigma_a")[[1]],
       sigma_state = rstan::extract(out, pars = "sigma_b")[[1]]) %>%
  gather(parameter,value) %>%
  ggplot(.,aes(x=value)) +
  geom_histogram(binwidth=0.001) +
  facet_grid(rows=vars(parameter))
# measurement noise
measure_noise_national <- rstan::extract(out, pars = "measure_noise_national")[[1]] * mean(rstan::extract(out, pars = "sigma_measure_noise_national")[[1]])
hist(measure_noise_national)
# look at variation in mu_a
mu_a <- rstan::extract(out, pars = "mu_a")[[1]]
lapply(1:100,
       function(x){
         tibble(mu_a_draw = inv.logit(mu_a[x,]),
                trial = x) %>%
           mutate(date = min(df$end) + row_number()) 
       }) %>%
  do.call('bind_rows',.) %>%
  ggplot(.,aes(x=date,y=mu_a_draw,group=trial)) +
  geom_line(alpha=0.2)
# extract predictions
predicted_score <- rstan::extract(out, pars = "predicted_score")[[1]]

p_obama <- pblapply(1:dim(predicted_score)[3],
                    function(x){
                      # pred is mu_a + mu_b for the past, just mu_b for the future
                      p_obama <- predicted_score[,,x]
                      
                      # put in tibble
                      tibble(low = apply(p_obama,2,function(x){(quantile(x,0.05))}),
                             high = apply(p_obama,2,function(x){(quantile(x,0.95))}),
                             mean = apply(p_obama,2,function(x){(mean(x))}),
                             prob = apply(p_obama,2,function(x){(mean(x>0.5))}),
                             state = x) 
                      
                    }) %>% do.call('bind_rows',.)

p_obama$state = colnames(state_correlation)[p_obama$state]

p_obama <- p_obama %>%
  group_by(state) %>%
  mutate(t = row_number() + min(df$begin)) %>%
  ungroup()

ex_states <- c('MT','FL','OH','IN','CO','PA','MO','NC','NH')

# together
# national vote = vote * state weights
p_obama <- p_obama %>%
  bind_rows(
    p_obama %>% 
      left_join(enframe(state_weights,'state','weight')) %>%
      group_by(t) %>%
      summarise(mean = weighted.mean(mean,weight),
                high = weighted.mean(high,weight),
                low = weighted.mean(low,weight)) %>%
      mutate(state='--')
  )

# look
p_obama %>% filter(t == max(t),state %in% c(ex_states,'--')) %>% mutate(se = (high - mean)/2)

urbnmapr::states %>%
  left_join(p_obama %>% filter(t == max(t)) %>%
              select(state_abbv=state,prob)) %>%
  ggplot(aes(x=long,y=lat,group=group,fill=prob)) +
  geom_polygon()  + 
  coord_map("albers",lat0=39, lat1=45) +
  scale_fill_gradient2(high='blue',low='red',mid='white',midpoint=0.5) +
  theme_void()


# electoral college by simulation
draws <- pblapply(1:dim(predicted_score)[3],
                  function(x){
                    # pred is mu_a + mu_b for the past, just mu_b for the future
                    p_obama <- predicted_score[,,x]
                    
                    p_obama <- p_obama %>%
                      as.data.frame() %>%
                      mutate(draw = row_number()) %>%
                      gather(t,p_obama,1:(ncol(.)-1)) %>%
                      mutate(t = as.numeric(gsub('V','',t)) + min(df$begin),
                             state = colnames(state_correlation)[x]) 
                    
                    
                  }) %>% do.call('bind_rows',.)


sim_evs <- draws %>%
  left_join(states2008 %>% select(state,ev),by='state') %>%
  group_by(t,draw) %>%
  summarise(dem_ev = sum(ev * (p_obama > 0.5))) %>%
  group_by(t) %>%
  summarise(mean_dem_ev = mean(dem_ev),
            median_dem_ev = median(dem_ev),
            high_dem_ev = quantile(dem_ev,0.975),
            low_dem_ev = quantile(dem_ev,0.025),
            prob = mean(dem_ev >= 270)) %>%
  left_join(p_obama[p_obama$state != '--',] %>%
              left_join(states2008 %>% select(state,ev),by='state') %>%
              group_by(t) %>%
              summarise(sum_dem_ev = sum(ev * (prob > 0.5))) )


# add identifier
identifier <- paste0(Sys.Date()," || " , out@model_name)

natl_polls.gg <- p_obama %>%
  filter(state == '--') %>%
  left_join(df %>% select(state,t,p_obama)) %>% # plot over time
  # plot
  ggplot(.,aes(x=t)) +
  geom_ribbon(aes(ymin=low,ymax=high),col=NA,alpha=0.2) +
  geom_hline(yintercept = 0.5) +
  geom_hline(yintercept = national_mu_prior,linetype=2) +
  geom_point(aes(y=p_obama),alpha=0.2) +
  geom_smooth(aes(y=p_obama),method='loess',span=0.2,col='black',linetype=2,se=F) +
  geom_line(aes(y=mean)) +
  facet_wrap(~state) +
  theme_minimal()  +
  theme(legend.position = 'none') +
  scale_x_date(limits=c(ymd('2008-03-01','2008-11-03')),date_breaks='1 month',date_labels='%b') +
  scale_y_continuous(breaks=seq(0,1,0.02)) +
  labs(subtitle='p_obama national')

natl_evs.gg <-  ggplot(sim_evs, aes(x=t)) +
  geom_hline(yintercept = 270) +
  geom_line(aes(y=mean_dem_ev)) +
  geom_line(aes(y=median_dem_ev),linetype=2) +
  geom_ribbon(aes(ymin=low_dem_ev,ymax=high_dem_ev),alpha=0.2) +
  theme_minimal()  +
  theme(legend.position = 'none') +
  scale_x_date(limits=c(ymd('2008-03-01','2008-11-03')),date_breaks='1 month',date_labels='%b') +
  scale_y_continuous(breaks=seq(0,600,100)) +
  labs(subtitletitle='obama evs')

state_polls.gg <- p_obama %>%
  filter(state %in% ex_states) %>%
  left_join(df %>% select(state,t,p_obama)) %>% # plot over time
  # plot
  ggplot(.,aes(x=t,col=state)) +
  geom_ribbon(aes(ymin=low,ymax=high),col=NA,alpha=0.2) +
  geom_hline(yintercept = 0.5) +
  geom_point(aes(y=p_obama),alpha=0.2) +
  #geom_smooth(aes(y=p_obama,col=state),method='loess',linetype=2,se=F) +
  geom_line(aes(y=mean)) +
  facet_wrap(~state) +
  theme_minimal()  +
  theme(legend.position = 'none') +
  scale_x_date(limits=c(ymd('2008-03-01','2008-11-03')),date_breaks='1 month',date_labels='%b') +
  scale_y_continuous(breaks=seq(0,1,0.05)) +
  labs(subtitle='p_obama state')

grid.arrange(natl_polls.gg, natl_evs.gg, state_polls.gg, 
             layout_matrix = rbind(c(1,1,3,3,3),
                                   c(2,2,3,3,3)),
             top = identifier
)


# probs v other forecasters
ggplot(sim_evs, aes(x=t)) +
  geom_hline(yintercept = 0.5) +
  geom_line(aes(y=prob))  +
  coord_cartesian(ylim=c(0,1)) +
  geom_hline(data=tibble(forecaster = c('pec','fivethirtyeight'),
                         prob = c(0.99,0.909)),
             aes(yintercept=prob,col=forecaster),linetype=2) +
  labs(subtitle = identifier)


# now-cast probability over time all states
p_obama %>%
  #filter(abs(mean-0.5)<0.2) %>%
  # plot
  ggplot(.,aes(x=t,y=prob,col=state)) +
  geom_hline(yintercept=0.5) +
  geom_line() +
  geom_label_repel(data = p_obama %>% 
                     filter(t==max(t),state %in% ex_states),
                   aes(label=state)) +
  theme_minimal()  +
  theme(legend.position = 'none') +
  scale_x_date(limits=c(ymd('2008-03-01','2008-11-03')),date_breaks='1 month',date_labels='%b') +
  scale_y_continuous(breaks=seq(0,1,0.1)) +
  labs(subtitle = identifier)

# diff from national over time?
p_obama[p_obama$state != '--',] %>%
  left_join(p_obama[p_obama$state=='--',] %>%
              select(t,p_obama_national=mean), by='t') %>%
  mutate(diff=mean-p_obama_national) %>%
  group_by(state) %>%
  mutate(last_prob = last(prob)) %>%
  filter(state %in% ex_states) %>%
  ggplot(.,aes(x=t,y=diff,col=state)) +
  geom_hline(yintercept=0.0) +
  geom_line() +
  geom_label_repel(data = . %>% 
                     filter(t==max(t),
                            state %in% ex_states),
                   aes(label=state)) +
  theme_minimal()  +
  theme(legend.position = 'none') +
  scale_x_date(limits=c(ymd('2008-03-01','2008-11-03')),date_breaks='1 month',date_labels='%b') +
  scale_y_continuous(breaks=seq(-1,1,0.01)) +
  labs(subtitle = identifier)

# brier scores
# https://www.buzzfeednews.com/article/jsvine/2016-election-forecast-grades
compare <- p_obama %>% 
  filter(t==max(t),state!='--') %>% 
  select(state,obama_win = prob) %>% 
  mutate(obama_win_actual = ifelse(state %in% c('CA','NV','OR','WA','CO','NM','MN','IL','VA','DC','MD','DE','NJ','CT','RI','MA','NH','VT','NY','HI','ME','MI','IA','OH','PA','WI','FL','NC','IN'),1,0),
         diff = (obama_win_actual - obama_win )^2) %>% 
  left_join(enframe(ev_state) %>% set_names(.,c('state','ev'))) %>% 
  mutate(ev_weight = ev/(sum(ev))) 


briers.2008 <- tibble(outlet='economist (backtest)',
       ev_wtd_brier = weighted.mean(compare$diff, compare$ev_weight),
       unwtd_brier = mean(compare$diff),
       states_correct=sum(round(compare$obama_win) == round(compare$obama_win_actual)))

briers.2008

# model vs final polls vs prior
p_obama %>%
  filter(t == max(t),state %in% ex_states) %>%
  mutate(se = (high - mean)/2) %>%
  select(state,model_mean=mean,model_se=se) %>%
  left_join(df %>%
              filter(t > (max(t)-14),
                     state %in% ex_states) %>%
              group_by(state) %>%
              summarise(poll = weighted.mean(p_obama,n_respondents))) %>%
  left_join(enframe(mu_b_prior,'state','prior') %>%
              mutate(prior = inv.logit(prior))) %>%
  ggplot(.,aes(y=state)) +
  geom_point(aes(x=poll,col='poll')) +
  geom_point(aes(x=model_mean,col='model')) +
  geom_point(aes(x=prior,col='prior'))

# expected EVs roughly match the stochastic simulations?
final_states <- enframe(mu_b_prior,'state','prior') %>%
  left_join(df %>%
              filter(t > (max(t)-14),) %>%
              group_by(state) %>%
              summarise(poll = weighted.mean(p_obama,n_respondents))) %>%
  mutate(avg_poll_less_prior = mean(poll - inv.logit(prior), na.rm=T)) %>%
  mutate(poll = ifelse(is.na(poll),
                       inv.logit(prior) + avg_poll_less_prior,
                       poll)) %>%
  select(state,poll)

errors <- mvtnorm::rmvnorm(100000, sigma = state_correlation) * 0.1^2

generated_evs <- lapply(1:ncol(errors),
                        function(x){
                          tibble( errors[,x] + final_states$poll[x]) %>% setNames(.,c(final_states$state[x]))
                        }) %>%
  bind_cols() %>%
  as.data.frame() %>%
  mutate(trial = row_number()) %>%
  gather(state,p_obama,1:(ncol(.)-1)) %>%
  left_join(states2008 %>% select(state,ev)) %>%
  group_by(trial) %>%
  summarise(dem_ev = sum((p_obama>0.5)*ev))

# final EV distribution
final_evs <- draws %>%
  left_join(states2008 %>% select(state,ev),by='state') %>%
  filter(t==max(t)) %>%
  group_by(draw) %>%
  summarise(dem_ev = sum(ev* (p_obama > 0.5)))


grid.arrange(
  ggplot(final_evs,aes(x=dem_ev,
                       fill=ifelse(dem_ev>=270,'Democratic','Republican'))) +
    geom_vline(xintercept = 270) +
    geom_histogram(binwidth=1) +
    theme_minimal() +
    theme(legend.position = 'top',
          panel.grid.minor = element_blank()) +
    scale_fill_manual(name='Electoral College winner',values=c('Democratic'='#3A4EB1','Republican'='#E40A04')) +
    labs(x='Democratic electoral college votes',title='2008, Potential Electoral College outcomes',
         subtitle=sprintf("p(dem win) = %s | full stan model",round(mean(final_evs$dem_ev>=270),3))),
  

    ggplot(generated_evs,aes(x=dem_ev,
                         fill=ifelse(dem_ev>=270,'Democratic','Republican'))) +
    geom_vline(xintercept = 270) +
    geom_histogram(binwidth=1) +
    theme_minimal() +
    theme(legend.position = 'top',
          panel.grid.minor = element_blank()) +
    scale_fill_manual(name='Electoral College winner',values=c('Democratic'='#3A4EB1','Republican'='#E40A04')) +
    labs(x='Winner',
         subtitle=sprintf("p(dem win) = %s | simple rmvnorm simulations",round(mean(generated_evs$dem_ev>=270),3)))
)
```

