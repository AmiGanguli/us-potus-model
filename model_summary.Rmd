---
title: "_The Economist_'s Presidential Election Forecasting Model"
subtitle: "Model designed in collaboration with Merlin Heidemanns and Andrew Gelman (Columbia University)"
date: "Last update on `r format(Sys.time(), '%A %B %d, %Y at %I:%M %p %Z',tz='US/Eastern')`"
output: 
  html_document:
    theme: readable
---

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(gridExtra)
library(boot)
library(pbapply)
library(urbnmapr)
library(ggrepel)
library(DT)

# copy/paste this code to console to run all models again and render this document:

# model version 12:
# source('scripts/R/Backtesting/v7_2008.R');source('scripts/R/Backtesting/v7_2012.R');source('scripts/R/Refactored/poll_run_v7.R');rmarkdown::render('model_summary.Rmd');beepr::beep(2)

# model version 13:
# source('scripts/R/Backtesting/v8_2008.R');source('scripts/R/Backtesting/v8_2012.R');source('scripts/R/Refactored/poll_run_v8.R');rmarkdown::render('model_summary.Rmd');beepr::beep(2)

# model version final:
# source('scripts/R/Backtesting/final_2008.R');source('scripts/R/Backtesting/final_2012.R');source('scripts/model/poll_model_2020.R');rmarkdown::render('model_summary.Rmd');beepr::beep(2);
```

## Methodology

Our forecasting model produces predictions for Democratic and Republican two-party vote share at the state and national level for every day in the election campaign. This section describes the method with which it arrives at those predictions. 

Following the model description is a summary of how the method performed in the 2008, 2012 and 2016 presidential elections. 

### Structure

It is useful to think of the model as a combination of pre-election polls with other data about election outcomes, sometimes referred to as the "fundamentals" of the campaign. These data translate the president's popularity and the economic environment into long-range forecasts of the final election outcome, made as early as March and updated throughout the election year. In the Bayesian sense, the model is using state and national polls to update these prior expectations of the political environment. 

We are interested not only in the precise vote-share predictions from the model, but also the level of certainty we do(n't) have in them. The model is thus made up of three different conceptual components:

1. Prior predictions
2. Polling averages
3. Exploration of uncertainty

The first two are easier to explain than the latter. But before we get there, let's address what data the model is ingesting.

### Data

TK
Prior: Head-to-heads + economic index throughout the election year
Polls: Well, polls :)

### Prior

TK

### Poll averaging

TK

### Uncertianty (or, how wrong could we be?)

TK

---

## Model performance {.tabset .tabset-fade}

Overall:


Select an election for more:

### 2008 

```{r include=F}
## Master variables
RUN_DATE <- min(ymd('2008-11-03'),Sys.Date())

election_day <- ymd("2008-11-03")
start_date <- as.Date("2008-03-01") # Keeping all polls after March 1, 2016
  
evs_df <- read_csv('data/2012.csv')

# will read in the most recent back-test for 2008
out  <- read_rds(sprintf('models/backtest_2008/stan_model_%s.rds',RUN_DATE))

# get all the polling data
#setwd(here("data/"))
all_polls <- read_csv('data/all_polls_2008.csv')

# select relevant columns from HufFPost polls
all_polls <- all_polls %>%
  dplyr::select(state, pollster, number.of.observations, mode,population,
                start.date, 
                end.date,
                obama, mccain, undecided, other)%>%
  mutate(end.date = mdy(end.date),
         start.date = mdy(start.date))


# make sure we've got nothing from the futuree
all_polls <- all_polls %>%
  filter(ymd(end.date) <= RUN_DATE)

# basic mutations
df <- all_polls %>% 
  tbl_df %>%
  rename(n = number.of.observations) %>%
  mutate(begin = ymd(start.date),
         end   = ymd(end.date),
         t = end - (1 + as.numeric(end-begin)) %/% 2) %>%
  filter(t >= start_date & !is.na(t)
         & n > 1) 

# pollster mutations
df <- df %>%
  mutate(pollster = str_extract(pollster, pattern = "[A-z0-9 ]+") %>% sub("\\s+$", "", .),
         pollster = replace(pollster, pollster == "Fox News", "FOX"), # Fixing inconsistencies in pollster names
         pollster = replace(pollster, pollster == "WashPost", "Washington Post"),
         pollster = replace(pollster, pollster == "ABC News", "ABC"),
         undecided = ifelse(is.na(undecided), 0, undecided),
         other = ifelse(is.na(other), 0, other))

# vote shares etc
df <- df %>%
  mutate(two_party_sum = obama + mccain,
         polltype = as.integer(as.character(recode(population, 
                                                   "Likely Voters" = "0", 
                                                   "Registered Voters" = "1",
                                                   "Adults" = "2"))), 
         n_respondents = round(n),
         # obama
         n_obama = round(n * obama/100),
         p_obama = obama/two_party_sum,
         # mccain
         n_mccain = round(n * mccain/100),
         p_mccain = mccain/two_party_sum,
         # third-party
         n_other = round(n * other/100),
         p_other = other/100)


# state info

#here("data")
state_data <- read.csv("data/potus_results_76_16.csv")

all_state_names <- levels(state_data$state)

# Numerical indices passed to Stan for states, days, weeks, pollsters
df <- df %>% 
  mutate(poll_day = t - min(t) + 1,
         # Factors are alphabetically sorted: 1 = --, 2 = AL, 3 = AK, 4 = AZ...
         index_s = as.numeric(factor(as.character(state),
                                     levels = c('--',all_state_names))),  # ensure levels are same as all 50 names in sate_correlation
         index_t = 1 + as.numeric(t) - min(as.numeric(t)),
         index_p = as.numeric(as.factor(as.character(pollster))))  

T <- as.integer(round(difftime(election_day, min(df$start.date))))

# selections
df <- df %>%
  arrange(state, t, polltype, two_party_sum) %>% 
  distinct(state, t, pollster, .keep_all = TRUE) %>%
  select(
    # poll information
    state, t, begin, end, pollster, polltype, method = mode, n_respondents, 
    # vote shares
    p_obama, n_obama, 
    p_mccain, n_mccain, 
    p_other, n_other, poll_day, index_s, index_p, index_t) %>%
  mutate(index_s = ifelse(index_s == 1, 52, index_s - 1)) # national index = 51


# state weights
#setwd(here("data/"))
state_elec_results <- read.csv("data/2008.csv", 
                       header = TRUE, stringsAsFactors = FALSE) %>% 
  mutate(score = obama_count / (obama_count + mccain_count),
         national_score = sum(obama_count)/sum(obama_count + mccain_count),
         delta = score - national_score,
         share_national_vote = (total_count)
         /sum(total_count)) %>%
  arrange(state) 

rownames(state_elec_results) <- state_elec_results$state

# get state incdices
all_states <- state_elec_results$state
state_name <- state_elec_results$state_name
names(state_name) <- state_elec_results$state

# set prior differences
prior_diff_score <- state_elec_results$delta
names(prior_diff_score) <- all_states

# set state weights
state_weights <- c(state_elec_results$share_national_vote / sum(state_elec_results$share_national_vote))
names(state_weights) <- c(state_elec_results$state)

# electoral votes, by state:
ev_state <- state_elec_results$ev
names(ev_state) <- state_elec_results$state

# hard code prior
national_mu_prior <- 0.566

# Mean of the mu_b_prior
mu_b_prior <- logit(national_mu_prior + prior_diff_score)

# etc
a <- rstan::extract(out, pars = "alpha")[[1]]
hist(a)
# sigmas
tibble(sigma_national = rstan::extract(out, pars = "sigma_a")[[1]],
       sigma_state = rstan::extract(out, pars = "sigma_b")[[1]]) %>%
  gather(parameter,value) %>%
  ggplot(.,aes(x=value)) +
  geom_histogram(binwidth=0.001) +
  facet_grid(rows=vars(parameter))
# measurement noise
measure_noise_national <- rstan::extract(out, pars = "measure_noise_national")[[1]] * mean(rstan::extract(out, pars = "sigma_measure_noise_national")[[1]])
hist(measure_noise_national)
# look at variation in mu_a
mu_a <- rstan::extract(out, pars = "mu_a")[[1]]
lapply(1:100,
       function(x){
         tibble(mu_a_draw = inv.logit(mu_a[x,]),
                trial = x) %>%
           mutate(date = min(df$end) + row_number()) 
       }) %>%
  do.call('bind_rows',.) %>%
  ggplot(.,aes(x=date,y=mu_a_draw,group=trial)) +
  geom_line(alpha=0.2)
# extract predictions
predicted_score <- rstan::extract(out, pars = "predicted_score")[[1]]

p_obama <- pblapply(1:dim(predicted_score)[3],
                    function(x){
                      # pred is mu_a + mu_b for the past, just mu_b for the future
                      p_obama <- predicted_score[,,x]
                      
                      # put in tibble
                      tibble(low = apply(p_obama,2,function(x){(quantile(x,0.05))}),
                             high = apply(p_obama,2,function(x){(quantile(x,0.95))}),
                             mean = apply(p_obama,2,function(x){(mean(x))}),
                             prob = apply(p_obama,2,function(x){(mean(x>0.5))}),
                             state = x) 
                      
                    }) %>% do.call('bind_rows',.)

p_obama$state = all_state_names[p_obama$state]

p_obama <- p_obama %>%
  group_by(state) %>%
  mutate(t = row_number() + min(df$begin)) %>%
  ungroup()

ex_states <- c('MT','FL','OH','IN','CO','PA','MO','NC','NH')

# together
# national vote = vote * state weights
p_obama <- p_obama %>%
  bind_rows(
    p_obama %>% 
      left_join(enframe(state_weights,'state','weight')) %>%
      group_by(t) %>%
      summarise(mean = weighted.mean(mean,weight),
                high = weighted.mean(high,weight),
                low = weighted.mean(low,weight)) %>%
      mutate(state='--')
  )

# look
p_obama %>% filter(t == max(t),state %in% c(ex_states,'--')) %>% mutate(se = (high - mean)/2)

map.2008.gg <- urbnmapr::states %>%
  left_join(p_obama %>% filter(t == max(t)) %>%
              select(state_abbv=state,prob)) %>%
  ggplot(aes(x=long,y=lat,group=group,fill=prob)) +
  geom_polygon()  + 
  coord_map("albers",lat0=39, lat1=45) +
  scale_fill_gradient2(high='blue',low='red',mid='white',midpoint=0.5) +
  theme_void()


# electoral college by simulation
draws <- pblapply(1:dim(predicted_score)[3],
                  function(x){
                    # pred is mu_a + mu_b for the past, just mu_b for the future
                    p_obama <- predicted_score[,,x]
                    
                    p_obama <- p_obama %>%
                      as.data.frame() %>%
                      mutate(draw = row_number()) %>%
                      gather(t,p_obama,1:(ncol(.)-1)) %>%
                      mutate(t = as.numeric(gsub('V','',t)) + min(df$begin),
                             state = all_state_names[x]) 
                    
                    
                  }) %>% do.call('bind_rows',.)


sim_evs <- draws %>%
  left_join(state_elec_results %>% select(state,ev),by='state') %>%
  group_by(t,draw) %>%
  summarise(dem_ev = sum(ev * (p_obama > 0.5))) %>%
  group_by(t) %>%
  summarise(mean_dem_ev = mean(dem_ev),
            median_dem_ev = median(dem_ev),
            high_dem_ev = quantile(dem_ev,0.975),
            low_dem_ev = quantile(dem_ev,0.025),
            prob = mean(dem_ev >= 270)) %>%
  left_join(p_obama[p_obama$state != '--',] %>%
              left_join(state_elec_results %>% select(state,ev),by='state') %>%
              group_by(t) %>%
              summarise(sum_dem_ev = sum(ev * (prob > 0.5))) )


# add identifier
identifier <- paste0(Sys.Date()," || " , out@model_name)

natl_polls.2008.gg <- p_obama %>%
  filter(state == '--') %>%
  left_join(df %>% select(state,t,p_obama)) %>% # plot over time
  # plot
  ggplot(.,aes(x=t)) +
  geom_ribbon(aes(ymin=low,ymax=high),col=NA,alpha=0.2) +
  geom_hline(yintercept = 0.5) +
  geom_hline(yintercept = national_mu_prior,linetype=2) +
  geom_point(aes(y=p_obama),alpha=0.2) +
  geom_smooth(aes(y=p_obama),method='loess',span=0.2,col='black',linetype=2,se=F) +
  geom_line(aes(y=mean)) +
  facet_wrap(~state) +
  theme_minimal()  +
  theme(legend.position = 'none') +
  scale_x_date(limits=c(ymd('2008-03-01','2008-11-03')),date_breaks='1 month',date_labels='%b') +
  scale_y_continuous(breaks=seq(0,1,0.02)) +
  labs(subtitle='p_obama national')

natl_evs.2008.gg <-  ggplot(sim_evs, aes(x=t)) +
  geom_hline(yintercept = 270) +
  geom_line(aes(y=mean_dem_ev)) +
  geom_line(aes(y=median_dem_ev),linetype=2) +
  geom_ribbon(aes(ymin=low_dem_ev,ymax=high_dem_ev),alpha=0.2) +
  theme_minimal()  +
  theme(legend.position = 'none') +
  scale_x_date(limits=c(ymd('2008-03-01','2008-11-03')),date_breaks='1 month',date_labels='%b') +
  scale_y_continuous(breaks=seq(0,600,100)) +
  labs(subtitletitle='obama evs')

state_polls.2008.gg <- p_obama %>%
  filter(state %in% ex_states) %>%
  left_join(df %>% select(state,t,p_obama)) %>% # plot over time
  # plot
  ggplot(.,aes(x=t,col=state)) +
  geom_ribbon(aes(ymin=low,ymax=high),col=NA,alpha=0.2) +
  geom_hline(yintercept = 0.5) +
  geom_point(aes(y=p_obama),alpha=0.2) +
  #geom_smooth(aes(y=p_obama,col=state),method='loess',linetype=2,se=F) +
  geom_line(aes(y=mean)) +
  facet_wrap(~state) +
  theme_minimal()  +
  theme(legend.position = 'none') +
  scale_x_date(limits=c(ymd('2008-03-01','2008-11-03')),date_breaks='1 month',date_labels='%b') +
  scale_y_continuous(breaks=seq(0,1,0.05)) +
  labs(subtitle='p_obama state')


# diff from national over time?
state_lean.2008.gg <- p_obama[p_obama$state != '--',] %>%
  left_join(p_obama[p_obama$state=='--',] %>%
              select(t,p_obama_national=mean), by='t') %>%
  mutate(diff=mean-p_obama_national) %>%
  group_by(state) %>%
  mutate(last_prob = last(prob)) %>%
  filter(state %in% ex_states) %>%
  ggplot(.,aes(x=t,y=diff,col=state)) +
  geom_hline(yintercept=0.0) +
  geom_line() +
  geom_label_repel(data = . %>% 
                     filter(t==max(t),
                            state %in% ex_states),
                   aes(label=state)) +
  theme_minimal()  +
  theme(legend.position = 'none') +
  scale_x_date(limits=c(ymd('2008-03-01','2008-11-03')),date_breaks='1 month',date_labels='%b') +
  scale_y_continuous(breaks=seq(-1,1,0.01)) +
  labs(subtitle = identifier)

# brier scores
# https://www.buzzfeednews.com/article/jsvine/2016-election-forecast-grades
compare <- p_obama %>% 
  filter(t==max(t),state!='--') %>% 
  select(state,obama_win = prob) %>% 
  mutate(obama_win_actual = ifelse(state %in% c('CA','NV','OR','WA','CO','NM','MN','IL','VA','DC','MD','DE','NJ','CT','RI','MA','NH','VT','NY','HI','ME','MI','IA','OH','PA','WI','FL','NC','IN'),1,0),
         diff = (obama_win_actual - obama_win )^2) %>% 
  left_join(enframe(ev_state) %>% set_names(.,c('state','ev'))) %>% 
  mutate(ev_weight = ev/(sum(ev))) 


briers.2008 <- tibble(outlet='economist (backtest)',
       ev_wtd_brier = weighted.mean(compare$diff, compare$ev_weight),
       unwtd_brier = mean(compare$diff),
       states_correct=sum(round(compare$obama_win) == round(compare$obama_win_actual)))


# model vs final polls vs prior
predictcompare.2008.gg <- p_obama %>%
  filter(t == max(t),state %in% ex_states) %>%
  mutate(se = (high - mean)/2) %>%
  select(state,model_mean=mean,model_se=se) %>%
  left_join(df %>%
              filter(t > (max(t)-14),
                     state %in% ex_states) %>%
              group_by(state) %>%
              summarise(poll = weighted.mean(p_obama,n_respondents))) %>%
  left_join(enframe(mu_b_prior,'state','prior') %>%
              mutate(prior = inv.logit(prior))) %>%
  ggplot(.,aes(y=state)) +
  geom_point(aes(x=poll,col='poll')) +
  geom_point(aes(x=model_mean,col='model')) +
  geom_point(aes(x=prior,col='prior'))

# expected EVs roughly match the stochastic simulations?
final_states <- enframe(mu_b_prior,'state','prior') %>%
  left_join(df %>%
              filter(t > (max(t)-14),) %>%
              group_by(state) %>%
              summarise(poll = weighted.mean(p_obama,n_respondents))) %>%
  mutate(avg_poll_less_prior = mean(poll - inv.logit(prior), na.rm=T)) %>%
  mutate(poll = ifelse(is.na(poll),
                       inv.logit(prior) + avg_poll_less_prior,
                       poll)) %>%
  select(state,poll)

# final EV distribution
final_evs <- draws %>%
  left_join(state_elec_results %>% select(state,ev),by='state') %>%
  filter(t==max(t)) %>%
  group_by(draw) %>%
  summarise(dem_ev = sum(ev* (p_obama > 0.5)))

final_evs.2008.gg <-  ggplot(final_evs,aes(x=dem_ev,
                       fill=ifelse(dem_ev>=270,'Democratic','Republican'))) +
    geom_vline(xintercept = 270) +
    geom_histogram(binwidth=1) +
    theme_minimal() +
    theme(legend.position = 'top',
          panel.grid.minor = element_blank()) +
    scale_fill_manual(name='Electoral College winner',values=c('Democratic'='#3A4EB1','Republican'='#E40A04')) +
    labs(x='Democratic electoral college votes',title='2008, Potential Electoral College outcomes',
         subtitle=sprintf("p(dem win) = %s | full stan model",round(mean(final_evs$dem_ev>=270),3)))


```

#### Map

```{r echo=F,message=F,warning=F}
map.2008.gg
```

#### Final electoral college histogram

```{r echo=F,message=F,warning=F}
final_evs.2008.gg
```

#### National and state polls and the electoral college over time

```{r echo=F,message=F,warning=F,fig.width = 9, fig.asp = .62}
grid.arrange(natl_polls.2008.gg, natl_evs.2008.gg, state_polls.2008.gg, 
             layout_matrix = rbind(c(1,1,3,3,3),
                                   c(2,2,3,3,3)),
             top = identifier
)
```

#### State vs national deltas over time

```{r echo=F,message=F,warning=F}
state_lean.2008.gg
```

#### Model results vs polls vs the prior

```{r echo=F,message=F,warning=F}
predictcompare.2008.gg
```

#### Performance

````{r echo=F,message=F,warning=F}
knitr::kable(briers.2008)
```

#### Predictions for each state

```{r echo=F,message=F,warning=F}
p_obama %>% 
  filter(t == max(t)) %>% 
  mutate(se = (high - mean)/2) %>%
  mutate(high = round(high,3),
         low = round(low,3),
         mean = round(mean,3),
         prob = round(prob,3),
         se = round(se,3)) %>%
  select(state,mean,low,high,prob,se) %>%
  arrange(abs(mean-0.5)) %>%
  datatable()
            
```

### 2012 

```{r include=F}
## Master variables
RUN_DATE <- min(ymd('2012-11-06'),Sys.Date())

election_day <- ymd("2012-11-06")
start_date <- as.Date("2012-03-01") # Keeping all polls after March 1, 2016
  
evs_df <- read_csv('data/2012.csv')

# will read in the most recent back-test for 2012
out  <- read_rds(sprintf('models/backtest_2012/stan_model_%s.rds',RUN_DATE))

# get all the polling data
#setwd(here("data/"))
all_polls <- read_csv('data/all_polls_2012.csv')

# select relevant columns from HufFPost polls
all_polls <- all_polls %>%
  dplyr::select(state, pollster, number.of.observations, mode,population,
                start.date, 
                end.date,
                obama, romney, undecided, other)%>%
  mutate(end.date = mdy(end.date),
         start.date = mdy(start.date))


# make sure we've got nothing from the futuree
all_polls <- all_polls %>%
  filter(ymd(end.date) <= RUN_DATE)

# basic mutations
df <- all_polls %>% 
  tbl_df %>%
  rename(n = number.of.observations) %>%
  mutate(begin = ymd(start.date),
         end   = ymd(end.date),
         t = end - (1 + as.numeric(end-begin)) %/% 2) %>%
  filter(t >= start_date & !is.na(t)
         & n > 1) 

# pollster mutations
df <- df %>%
  mutate(pollster = str_extract(pollster, pattern = "[A-z0-9 ]+") %>% sub("\\s+$", "", .),
         pollster = replace(pollster, pollster == "Fox News", "FOX"), # Fixing inconsistencies in pollster names
         pollster = replace(pollster, pollster == "WashPost", "Washington Post"),
         pollster = replace(pollster, pollster == "ABC News", "ABC"),
         undecided = ifelse(is.na(undecided), 0, undecided),
         other = ifelse(is.na(other), 0, other))

# vote shares etc
df <- df %>%
  mutate(two_party_sum = obama + romney,
         polltype = as.integer(as.character(recode(population, 
                                                   "Likely Voters" = "0", 
                                                   "Registered Voters" = "1",
                                                   "Adults" = "2"))), 
         n_respondents = round(n),
         # obama
         n_obama = round(n * obama/100),
         p_obama = obama/two_party_sum,
         # romney
         n_romney = round(n * romney/100),
         p_romney = romney/two_party_sum,
         # third-party
         n_other = round(n * other/100),
         p_other = other/100)


# state info

#here("data")
state_data <- read.csv("data/potus_results_76_16.csv")

all_state_names <- levels(state_data$state)

# Numerical indices passed to Stan for states, days, weeks, pollsters
df <- df %>% 
  mutate(poll_day = t - min(t) + 1,
         # Factors are alphabetically sorted: 1 = --, 2 = AL, 3 = AK, 4 = AZ...
         index_s = as.numeric(factor(as.character(state),
                                     levels = c('--',all_state_names))),  # ensure levels are same as all 50 names in sate_correlation
         index_t = 1 + as.numeric(t) - min(as.numeric(t)),
         index_p = as.numeric(as.factor(as.character(pollster))))  

T <- as.integer(round(difftime(election_day, min(df$start.date))))

# selections
df <- df %>%
  arrange(state, t, polltype, two_party_sum) %>% 
  distinct(state, t, pollster, .keep_all = TRUE) %>%
  select(
    # poll information
    state, t, begin, end, pollster, polltype, method = mode, n_respondents, 
    # vote shares
    p_obama, n_obama, 
    p_romney, n_romney, 
    p_other, n_other, poll_day, index_s, index_p, index_t) %>%
  mutate(index_s = ifelse(index_s == 1, 52, index_s - 1)) # national index = 51


# state weights
#setwd(here("data/"))
state_elec_results <- read.csv("data/2012.csv", 
                       header = TRUE, stringsAsFactors = FALSE) %>% 
  mutate(score = obama_count / (obama_count + romney_count),
         national_score = sum(obama_count)/sum(obama_count + romney_count),
         delta = score - national_score,
         share_national_vote = (total_count)
         /sum(total_count)) %>%
  arrange(state) 

rownames(state_elec_results) <- state_elec_results$state

# get state incdices
all_states <- state_elec_results$state
state_name <- state_elec_results$state_name
names(state_name) <- state_elec_results$state

# set prior differences
prior_diff_score <- state_elec_results$delta
names(prior_diff_score) <- all_states

# set state weights
state_weights <- c(state_elec_results$share_national_vote / sum(state_elec_results$share_national_vote))
names(state_weights) <- c(state_elec_results$state)

# electoral votes, by state:
ev_state <- state_elec_results$ev
names(ev_state) <- state_elec_results$state

# makes priors
national_mu_prior <- 0.502

# Mean of the mu_b_prior
mu_b_prior <- logit(national_mu_prior + prior_diff_score)

# etc
a <- rstan::extract(out, pars = "alpha")[[1]]
hist(a)
# sigmas
tibble(sigma_national = rstan::extract(out, pars = "sigma_a")[[1]],
       sigma_state = rstan::extract(out, pars = "sigma_b")[[1]]) %>%
  gather(parameter,value) %>%
  ggplot(.,aes(x=value)) +
  geom_histogram(binwidth=0.001) +
  facet_grid(rows=vars(parameter))
# measurement noise
measure_noise_national <- rstan::extract(out, pars = "measure_noise_national")[[1]] * mean(rstan::extract(out, pars = "sigma_measure_noise_national")[[1]])
hist(measure_noise_national)
# look at variation in mu_a
mu_a <- rstan::extract(out, pars = "mu_a")[[1]]
lapply(1:100,
       function(x){
         tibble(mu_a_draw = inv.logit(mu_a[x,]),
                trial = x) %>%
           mutate(date = min(df$end) + row_number()) 
       }) %>%
  do.call('bind_rows',.) %>%
  ggplot(.,aes(x=date,y=mu_a_draw,group=trial)) +
  geom_line(alpha=0.2)
# extract predictions
predicted_score <- rstan::extract(out, pars = "predicted_score")[[1]]

p_obama <- pblapply(1:dim(predicted_score)[3],
                    function(x){
                      # pred is mu_a + mu_b for the past, just mu_b for the future
                      p_obama <- predicted_score[,,x]
                      
                      # put in tibble
                      tibble(low = apply(p_obama,2,function(x){(quantile(x,0.05))}),
                             high = apply(p_obama,2,function(x){(quantile(x,0.95))}),
                             mean = apply(p_obama,2,function(x){(mean(x))}),
                             prob = apply(p_obama,2,function(x){(mean(x>0.5))}),
                             state = x) 
                      
                    }) %>% do.call('bind_rows',.)

p_obama$state = all_state_names[p_obama$state]

p_obama <- p_obama %>%
  group_by(state) %>%
  mutate(t = row_number() + min(df$begin)) %>%
  ungroup()

ex_states <- c('NC','FL','OH','MI','WI','PA','VA','NV','NH')

# together
# national vote = vote * state weights
p_obama <- p_obama %>%
  bind_rows(
    p_obama %>% 
      left_join(enframe(state_weights,'state','weight')) %>%
      group_by(t) %>%
      summarise(mean = weighted.mean(mean,weight),
                high = weighted.mean(high,weight),
                low = weighted.mean(low,weight)) %>%
      mutate(state='--')
  )

# look
p_obama %>% filter(t == max(t),state %in% c(ex_states,'--')) %>% mutate(se = (high - mean)/2)

map.2012.gg <- urbnmapr::states %>%
  left_join(p_obama %>% filter(t == max(t)) %>%
              select(state_abbv=state,prob)) %>%
  ggplot(aes(x=long,y=lat,group=group,fill=prob)) +
  geom_polygon()  + 
  coord_map("albers",lat0=39, lat1=45) +
  scale_fill_gradient2(high='blue',low='red',mid='white',midpoint=0.5) +
  theme_void()


# electoral college by simulation
draws <- pblapply(1:dim(predicted_score)[3],
                  function(x){
                    # pred is mu_a + mu_b for the past, just mu_b for the future
                    p_obama <- predicted_score[,,x]
                    
                    p_obama <- p_obama %>%
                      as.data.frame() %>%
                      mutate(draw = row_number()) %>%
                      gather(t,p_obama,1:(ncol(.)-1)) %>%
                      mutate(t = as.numeric(gsub('V','',t)) + min(df$begin),
                             state = all_state_names[x]) 
                    
                    
                  }) %>% do.call('bind_rows',.)


sim_evs <- draws %>%
  left_join(state_elec_results %>% select(state,ev),by='state') %>%
  group_by(t,draw) %>%
  summarise(dem_ev = sum(ev * (p_obama > 0.5))) %>%
  group_by(t) %>%
  summarise(mean_dem_ev = mean(dem_ev),
            median_dem_ev = median(dem_ev),
            high_dem_ev = quantile(dem_ev,0.975),
            low_dem_ev = quantile(dem_ev,0.025),
            prob = mean(dem_ev >= 270)) %>%
  left_join(p_obama[p_obama$state != '--',] %>%
              left_join(state_elec_results %>% select(state,ev),by='state') %>%
              group_by(t) %>%
              summarise(sum_dem_ev = sum(ev * (prob > 0.5))) )


# add identifier
identifier <- paste0(Sys.Date()," || " , out@model_name)

natl_polls.2012.gg <- p_obama %>%
  filter(state == '--') %>%
  left_join(df %>% select(state,t,p_obama)) %>% # plot over time
  # plot
  ggplot(.,aes(x=t)) +
  geom_ribbon(aes(ymin=low,ymax=high),col=NA,alpha=0.2) +
  geom_hline(yintercept = 0.5) +
  geom_hline(yintercept = national_mu_prior,linetype=2) +
  geom_point(aes(y=p_obama),alpha=0.2) +
  geom_smooth(aes(y=p_obama),method='loess',span=0.2,col='black',linetype=2,se=F) +
  geom_line(aes(y=mean)) +
  facet_wrap(~state) +
  theme_minimal()  +
  theme(legend.position = 'none') +
  scale_x_date(limits=c(ymd('2012-03-01','2012-11-06')),date_breaks='1 month',date_labels='%b') +
  scale_y_continuous(breaks=seq(0,1,0.02)) +
  labs(subtitle='p_obama national')

natl_evs.2012.gg <-  ggplot(sim_evs, aes(x=t)) +
  geom_hline(yintercept = 270) +
  geom_line(aes(y=mean_dem_ev)) +
  geom_line(aes(y=median_dem_ev),linetype=2) +
  geom_ribbon(aes(ymin=low_dem_ev,ymax=high_dem_ev),alpha=0.2) +
  theme_minimal()  +
  theme(legend.position = 'none') +
  scale_x_date(limits=c(ymd('2012-03-01','2012-11-06')),date_breaks='1 month',date_labels='%b') +
  scale_y_continuous(breaks=seq(0,600,100)) +
  labs(subtitletitle='obama evs')

state_polls.2012.gg <- p_obama %>%
  filter(state %in% ex_states) %>%
  left_join(df %>% select(state,t,p_obama)) %>% # plot over time
  # plot
  ggplot(.,aes(x=t,col=state)) +
  geom_ribbon(aes(ymin=low,ymax=high),col=NA,alpha=0.2) +
  geom_hline(yintercept = 0.5) +
  geom_point(aes(y=p_obama),alpha=0.2) +
  #geom_smooth(aes(y=p_obama,col=state),method='loess',linetype=2,se=F) +
  geom_line(aes(y=mean)) +
  facet_wrap(~state) +
  theme_minimal()  +
  theme(legend.position = 'none') +
  scale_x_date(limits=c(ymd('2012-03-01','2012-11-06')),date_breaks='1 month',date_labels='%b') +
  scale_y_continuous(breaks=seq(0,1,0.05)) +
  labs(subtitle='p_obama state')


# diff from national over time?
state_lean.2012.gg <- p_obama[p_obama$state != '--',] %>%
  left_join(p_obama[p_obama$state=='--',] %>%
              select(t,p_obama_national=mean), by='t') %>%
  mutate(diff=mean-p_obama_national) %>%
  group_by(state) %>%
  mutate(last_prob = last(prob)) %>%
  filter(state %in% ex_states) %>%
  ggplot(.,aes(x=t,y=diff,col=state)) +
  geom_hline(yintercept=0.0) +
  geom_line() +
  geom_label_repel(data = . %>% 
                     filter(t==max(t),
                            state %in% ex_states),
                   aes(label=state)) +
  theme_minimal()  +
  theme(legend.position = 'none') +
  scale_x_date(limits=c(ymd('2012-03-01','2012-11-06')),date_breaks='1 month',date_labels='%b') +
  scale_y_continuous(breaks=seq(-1,1,0.01)) +
  labs(subtitle = identifier)

# brier scores
# https://www.buzzfeednews.com/article/jsvine/2016-election-forecast-grades
compare <- p_obama %>% 
  filter(t==max(t),state!='--') %>% 
  select(state,obama_win = prob) %>% 
  mutate(obama_win_actual = ifelse(state %in% c('CA','NV','OR','WA','CO','NM','MN','IL','VA','DC','MD','DE','NJ','CT','RI','MA','NH','VT','NY','HI','ME','MI','IA','OH','PA','WI','FL'),1,0),
         diff = (obama_win_actual - obama_win )^2) %>% 
  left_join(enframe(ev_state) %>% set_names(.,c('state','ev'))) %>% 
  mutate(ev_weight = ev/(sum(ev))) 


briers.2012 <- tibble(outlet = c('Linzer','Wang/Ferguson','Silver/538','Jackman/Pollster','Desart/Holbrook',
                  'Intrade','Enten/Margin of Error'),
       ev_wtd_brier = rep(NA,7),
       unwtd_brier = c(0.0038,0.00761,0.00911,0.00971,0.01605,0.02812,0.05075),
) %>% 
  bind_rows(tibble(outlet='economist (backtest)',
                   ev_wtd_brier = weighted.mean(compare$diff, compare$ev_weight),
                   unwtd_brier = mean(compare$diff),
                   states_correct=sum(round(compare$obama_win) == round(compare$obama_win_actual)))) %>%
  arrange(unwtd_brier)


# model vs final polls vs prior
predictcompare.2012.gg <- p_obama %>%
  filter(t == max(t),state %in% ex_states) %>%
  mutate(se = (high - mean)/2) %>%
  select(state,model_mean=mean,model_se=se) %>%
  left_join(df %>%
              filter(t > (max(t)-14),
                     state %in% ex_states) %>%
              group_by(state) %>%
              summarise(poll = weighted.mean(p_obama,n_respondents))) %>%
  left_join(enframe(mu_b_prior,'state','prior') %>%
              mutate(prior = inv.logit(prior))) %>%
  ggplot(.,aes(y=state)) +
  geom_point(aes(x=poll,col='poll')) +
  geom_point(aes(x=model_mean,col='model')) +
  geom_point(aes(x=prior,col='prior'))

# expected EVs roughly match the stochastic simulations?
final_states <- enframe(mu_b_prior,'state','prior') %>%
  left_join(df %>%
              filter(t > (max(t)-14),) %>%
              group_by(state) %>%
              summarise(poll = weighted.mean(p_obama,n_respondents))) %>%
  mutate(avg_poll_less_prior = mean(poll - inv.logit(prior), na.rm=T)) %>%
  mutate(poll = ifelse(is.na(poll),
                       inv.logit(prior) + avg_poll_less_prior,
                       poll)) %>%
  select(state,poll)

# final EV distribution
final_evs <- draws %>%
  left_join(state_elec_results %>% select(state,ev),by='state') %>%
  filter(t==max(t)) %>%
  group_by(draw) %>%
  summarise(dem_ev = sum(ev* (p_obama > 0.5)))

final_evs.2012.gg <-  ggplot(final_evs,aes(x=dem_ev,
                       fill=ifelse(dem_ev>=270,'Democratic','Republican'))) +
    geom_vline(xintercept = 270) +
    geom_histogram(binwidth=1) +
    theme_minimal() +
    theme(legend.position = 'top',
          panel.grid.minor = element_blank()) +
    scale_fill_manual(name='Electoral College winner',values=c('Democratic'='#3A4EB1','Republican'='#E40A04')) +
    labs(x='Democratic electoral college votes',title='2012, Potential Electoral College outcomes',
         subtitle=sprintf("p(dem win) = %s | full stan model",round(mean(final_evs$dem_ev>=270),3)))


```


#### Map

```{r echo=F,message=F,warning=F}
map.2012.gg
```

#### Final electoral college histogram

```{r echo=F,message=F,warning=F}
final_evs.2012.gg
```

#### National and state polls and the electoral college over time

```{r echo=F,message=F,warning=F,fig.width = 9, fig.asp = .62}
grid.arrange(natl_polls.2012.gg, natl_evs.2012.gg, state_polls.2012.gg, 
             layout_matrix = rbind(c(1,1,3,3,3),
                                   c(2,2,3,3,3)),
             top = identifier
)
```

#### State vs national deltas over time

```{r echo=F,message=F,warning=F}
state_lean.2012.gg
```

#### Model results vs polls vs the prior

```{r echo=F,message=F,warning=F}
predictcompare.2012.gg
```

#### Performance

````{r echo=F,message=F,warning=F}
knitr::kable(briers.2012)
```


#### Predictions for each state

```{r echo=F,message=F,warning=F}
p_obama %>% 
  filter(t == max(t)) %>% 
  mutate(se = (high - mean)/2) %>%
  mutate(high = round(high,3),
         low = round(low,3),
         mean = round(mean,3),
         prob = round(prob,3),
         se = round(se,3)) %>%
  select(state,mean,low,high,prob,se) %>%
  arrange(abs(mean-0.5)) %>%
  datatable()
            
```

### 2016

```{r include=F}
## Master variables
RUN_DATE <- min(ymd('2016-11-08'),Sys.Date())

election_day <- ymd("2016-11-08")
start_date <- as.Date("2016-03-01") # Keeping all polls after March 1, 2016
  
evs_df <- read_csv('data/2012.csv')

# will read in the most recent back-test for 2012
out  <- read_rds(sprintf('models/stan_model_%s.rds',RUN_DATE))

# get all the polling data
#setwd(here("data/"))
all_polls <- read_csv('data/all_polls.csv')

# select relevant columns from HufFPost polls
all_polls <- all_polls %>%
  dplyr::select(state, pollster, number.of.observations, mode,population,
                start.date, 
                end.date,
                clinton, trump, undecided, other)%>%
  mutate(end.date = ymd(end.date),
         start.date = ymd(start.date))


# make sure we've got nothing from the futuree
all_polls <- all_polls %>%
  filter(ymd(end.date) <= RUN_DATE)

# basic mutations
df <- all_polls %>% 
  tbl_df %>%
  rename(n = number.of.observations) %>%
  mutate(begin = ymd(start.date),
         end   = ymd(end.date),
         t = end - (1 + as.numeric(end-begin)) %/% 2) %>%
  filter(t >= start_date & !is.na(t)
         & n > 1) 

# pollster mutations
df <- df %>%
  mutate(pollster = str_extract(pollster, pattern = "[A-z0-9 ]+") %>% sub("\\s+$", "", .),
         pollster = replace(pollster, pollster == "Fox News", "FOX"), # Fixing inconsistencies in pollster names
         pollster = replace(pollster, pollster == "WashPost", "Washington Post"),
         pollster = replace(pollster, pollster == "ABC News", "ABC"),
         undecided = ifelse(is.na(undecided), 0, undecided),
         other = ifelse(is.na(other), 0, other))

# vote shares etc
df <- df %>%
  mutate(two_party_sum = clinton + trump,
         polltype = as.integer(as.character(recode(population, 
                                                   "Likely Voters" = "0", 
                                                   "Registered Voters" = "1",
                                                   "Adults" = "2"))), 
         n_respondents = round(n),
         # clinton
         n_clinton = round(n * clinton/100),
         p_clinton = clinton/two_party_sum,
         # trump
         n_trump = round(n * trump/100),
         p_trump = trump/two_party_sum,
         # third-party
         n_other = round(n * other/100),
         p_other = other/100)


# state info

#here("data")
state_data <- read.csv("data/potus_results_76_16.csv")

all_state_names <- levels(state_data$state)

# Numerical indices passed to Stan for states, days, weeks, pollsters
df <- df %>% 
  mutate(poll_day = t - min(t) + 1,
         # Factors are alphabetically sorted: 1 = --, 2 = AL, 3 = AK, 4 = AZ...
         index_s = as.numeric(factor(as.character(state),
                                     levels = c('--',all_state_names))),  # ensure levels are same as all 50 names in sate_correlation
         index_t = 1 + as.numeric(t) - min(as.numeric(t)),
         index_p = as.numeric(as.factor(as.character(pollster))))  

T <- as.integer(round(difftime(election_day, min(df$start.date))))

# selections
df <- df %>%
  arrange(state, t, polltype, two_party_sum) %>% 
  distinct(state, t, pollster, .keep_all = TRUE) %>%
  select(
    # poll information
    state, t, begin, end, pollster, polltype, method = mode, n_respondents, 
    # vote shares
    p_clinton, n_clinton, 
    p_trump, n_trump, 
    p_other, n_other, poll_day, index_s, index_p, index_t) %>%
  mutate(index_s = ifelse(index_s == 1, 52, index_s - 1)) # national index = 51


# state weights
#setwd(here("data/"))
state_elec_results <- read.csv("data/2012.csv", 
                       header = TRUE, stringsAsFactors = FALSE) %>% 
  mutate(score = obama_count / (obama_count + romney_count),
         national_score = sum(obama_count)/sum(obama_count + romney_count),
         delta = score - national_score,
         share_national_vote = (total_count)
         /sum(total_count)) %>%
  arrange(state) 

rownames(state_elec_results) <- state_elec_results$state

# get state incdices
all_states <- state_elec_results$state
state_name <- state_elec_results$state_name
names(state_name) <- state_elec_results$state

# set prior differences
prior_diff_score <- state_elec_results$delta
names(prior_diff_score) <- all_states

# set state weights
state_weights <- c(state_elec_results$share_national_vote / sum(state_elec_results$share_national_vote))
names(state_weights) <- c(state_elec_results$state)

# electoral votes, by state:
ev_state <- state_elec_results$ev
names(ev_state) <- state_elec_results$state

# makes priors
national_mu_prior <- 0.506

# Mean of the mu_b_prior
mu_b_prior <- logit(national_mu_prior + prior_diff_score)

# etc
a <- rstan::extract(out, pars = "alpha")[[1]]
hist(a)
# sigmas
tibble(sigma_national = rstan::extract(out, pars = "sigma_a")[[1]],
       sigma_state = rstan::extract(out, pars = "sigma_b")[[1]]) %>%
  gather(parameter,value) %>%
  ggplot(.,aes(x=value)) +
  geom_histogram(binwidth=0.001) +
  facet_grid(rows=vars(parameter))
# measurement noise
measure_noise_national <- rstan::extract(out, pars = "measure_noise_national")[[1]] * mean(rstan::extract(out, pars = "sigma_measure_noise_national")[[1]])
hist(measure_noise_national)
# look at variation in mu_a
mu_a <- rstan::extract(out, pars = "mu_a")[[1]]
lapply(1:100,
       function(x){
         tibble(mu_a_draw = inv.logit(mu_a[x,]),
                trial = x) %>%
           mutate(date = min(df$end) + row_number()) 
       }) %>%
  do.call('bind_rows',.) %>%
  ggplot(.,aes(x=date,y=mu_a_draw,group=trial)) +
  geom_line(alpha=0.2)
# extract predictions
predicted_score <- rstan::extract(out, pars = "predicted_score")[[1]]

p_clinton <- pblapply(1:dim(predicted_score)[3],
                    function(x){
                      # pred is mu_a + mu_b for the past, just mu_b for the future
                      p_clinton <- predicted_score[,,x]
                      
                      # put in tibble
                      tibble(low = apply(p_clinton,2,function(x){(quantile(x,0.05))}),
                             high = apply(p_clinton,2,function(x){(quantile(x,0.95))}),
                             mean = apply(p_clinton,2,function(x){(mean(x))}),
                             prob = apply(p_clinton,2,function(x){(mean(x>0.5))}),
                             state = x) 
                      
                    }) %>% do.call('bind_rows',.)

p_clinton$state = all_state_names[p_clinton$state]

p_clinton <- p_clinton %>%
  group_by(state) %>%
  mutate(t = row_number() + min(df$begin)) %>%
  ungroup()

ex_states <- c('NC','FL','OH','MI','WI','PA','VA','NV','NH')

# together
# national vote = vote * state weights
p_clinton <- p_clinton %>%
  bind_rows(
    p_clinton %>% 
      left_join(enframe(state_weights,'state','weight')) %>%
      group_by(t) %>%
      summarise(mean = weighted.mean(mean,weight),
                high = weighted.mean(high,weight),
                low = weighted.mean(low,weight)) %>%
      mutate(state='--')
  )


map.2016.gg <- urbnmapr::states %>%
  left_join(p_clinton %>% filter(t == max(t)) %>%
              select(state_abbv=state,prob)) %>%
  ggplot(aes(x=long,y=lat,group=group,fill=prob)) +
  geom_polygon()  + 
  coord_map("albers",lat0=39, lat1=45) +
  scale_fill_gradient2(high='blue',low='red',mid='white',midpoint=0.5) +
  theme_void()


# electoral college by simulation
draws <- pblapply(1:dim(predicted_score)[3],
                  function(x){
                    # pred is mu_a + mu_b for the past, just mu_b for the future
                    p_clinton <- predicted_score[,,x]
                    
                    p_clinton <- p_clinton %>%
                      as.data.frame() %>%
                      mutate(draw = row_number()) %>%
                      gather(t,p_clinton,1:(ncol(.)-1)) %>%
                      mutate(t = as.numeric(gsub('V','',t)) + min(df$begin),
                             state = all_state_names[x]) 
                    
                    
                  }) %>% do.call('bind_rows',.)


sim_evs <- draws %>%
  left_join(state_elec_results %>% select(state,ev),by='state') %>%
  group_by(t,draw) %>%
  summarise(dem_ev = sum(ev * (p_clinton > 0.5))) %>%
  group_by(t) %>%
  summarise(mean_dem_ev = mean(dem_ev),
            median_dem_ev = median(dem_ev),
            high_dem_ev = quantile(dem_ev,0.975),
            low_dem_ev = quantile(dem_ev,0.025),
            prob = mean(dem_ev >= 270)) %>%
  left_join(p_clinton[p_clinton$state != '--',] %>%
              left_join(state_elec_results %>% select(state,ev),by='state') %>%
              group_by(t) %>%
              summarise(sum_dem_ev = sum(ev * (prob > 0.5))) )


# add identifier
identifier <- paste0(Sys.Date()," || " , out@model_name)

natl_polls.2016.gg <- p_clinton %>%
  filter(state == '--') %>%
  left_join(df %>% select(state,t,p_clinton)) %>% # plot over time
  # plot
  ggplot(.,aes(x=t)) +
  geom_ribbon(aes(ymin=low,ymax=high),col=NA,alpha=0.2) +
  geom_hline(yintercept = 0.5) +
  geom_hline(yintercept = national_mu_prior,linetype=2) +
  geom_point(aes(y=p_clinton),alpha=0.2) +
  geom_smooth(aes(y=p_clinton),method='loess',span=0.2,col='black',linetype=2,se=F) +
  geom_line(aes(y=mean)) +
  facet_wrap(~state) +
  theme_minimal()  +
  theme(legend.position = 'none') +
  scale_x_date(limits=c(ymd('2016-03-01','2016-11-08')),date_breaks='1 month',date_labels='%b') +
  scale_y_continuous(breaks=seq(0,1,0.02)) +
  labs(subtitle='p_clinton national')

natl_evs.2016.gg <-  ggplot(sim_evs, aes(x=t)) +
  geom_hline(yintercept = 270) +
  geom_line(aes(y=mean_dem_ev)) +
  geom_line(aes(y=median_dem_ev),linetype=2) +
  geom_ribbon(aes(ymin=low_dem_ev,ymax=high_dem_ev),alpha=0.2) +
  theme_minimal()  +
  theme(legend.position = 'none') +
  scale_x_date(limits=c(ymd('2016-03-01','2016-11-08')),date_breaks='1 month',date_labels='%b') +
  scale_y_continuous(breaks=seq(0,600,100)) +
  labs(subtitletitle='clinton evs')

state_polls.2016.gg <- p_clinton %>%
  filter(state %in% ex_states) %>%
  left_join(df %>% select(state,t,p_clinton)) %>% # plot over time
  # plot
  ggplot(.,aes(x=t,col=state)) +
  geom_ribbon(aes(ymin=low,ymax=high),col=NA,alpha=0.2) +
  geom_hline(yintercept = 0.5) +
  geom_point(aes(y=p_clinton),alpha=0.2) +
  #geom_smooth(aes(y=p_clinton,col=state),method='loess',linetype=2,se=F) +
  geom_line(aes(y=mean)) +
  facet_wrap(~state) +
  theme_minimal()  +
  theme(legend.position = 'none') +
  scale_x_date(limits=c(ymd('2016-03-01','2016-11-08')),date_breaks='1 month',date_labels='%b') +
  scale_y_continuous(breaks=seq(0,1,0.05)) +
  labs(subtitle='p_clinton state')


# diff from national over time?
state_lean.2016.gg <- p_clinton[p_clinton$state != '--',] %>%
  left_join(p_clinton[p_clinton$state=='--',] %>%
              select(t,p_clinton_national=mean), by='t') %>%
  mutate(diff=mean-p_clinton_national) %>%
  group_by(state) %>%
  mutate(last_prob = last(prob)) %>%
  filter(state %in% ex_states) %>%
  ggplot(.,aes(x=t,y=diff,col=state)) +
  geom_hline(yintercept=0.0) +
  geom_line() +
  geom_label_repel(data = . %>% 
                     filter(t==max(t),
                            state %in% ex_states),
                   aes(label=state)) +
  theme_minimal()  +
  theme(legend.position = 'none') +
  scale_x_date(limits=c(ymd('2016-03-01','2016-11-08')),date_breaks='1 month',date_labels='%b') +
  scale_y_continuous(breaks=seq(-1,1,0.01)) +
  labs(subtitle = identifier)

# brier scores
# https://www.buzzfeednews.com/article/jsvine/2016-election-forecast-grades
compare <- p_clinton %>% 
  filter(t==max(t),state!='--') %>% 
  select(state,clinton_win=prob) %>% 
  mutate(clinton_win_actual = ifelse(state %in% c('CA','NV','OR','WA','CO','NM','MN','IL','VA','DC','MD','DE','NJ','CT','RI','MA','NH','VT','NY','HI','ME'),1,0),
         diff = (clinton_win_actual - clinton_win )^2) %>% left_join(enframe(ev_state) %>% set_names(.,c('state','ev'))) %>% 
  mutate(ev_weight = ev/(sum(ev))) 


briers.2016 <- tibble(outlet = c('538 polls-plus','538 polls-only','princeton','nyt upshot','kremp/slate','pollsavvy','predictwise markets','predictwise overall','desart and holbrook','daily kos','huffpost'),
       ev_wtd_brier = c(0.0928,0.0936,0.1169,0.1208,0.121,0.1219,0.1272,0.1276,0.1279,0.1439,0.1505),
       unwtd_brier = c(0.0664,0.0672,0.0744,0.0801,0.0766,0.0794,0.0767,0.0783,0.0825,0.0864,0.0892),
       states_correct = c(46,46,47,46,46,46,46,46,44,46,46)) %>% 
  bind_rows(tibble(outlet='economist (backtest)',
                   ev_wtd_brier = weighted.mean(compare$diff, compare$ev_weight),
                   unwtd_brier = mean(compare$diff),
                   states_correct=sum(round(compare$clinton_win) == round(compare$clinton_win_actual)))) %>%
  arrange(ev_wtd_brier) 


# model vs final polls vs prior
predictcompare.2016.gg <- p_clinton %>%
  filter(t == max(t),state %in% ex_states) %>%
  mutate(se = (high - mean)/2) %>%
  select(state,model_mean=mean,model_se=se) %>%
  left_join(df %>%
              filter(t > (max(t)-14),
                     state %in% ex_states) %>%
              group_by(state) %>%
              summarise(poll = weighted.mean(p_clinton,n_respondents))) %>%
  left_join(enframe(mu_b_prior,'state','prior') %>%
              mutate(prior = inv.logit(prior))) %>%
  ggplot(.,aes(y=state)) +
  geom_point(aes(x=poll,col='poll')) +
  geom_point(aes(x=model_mean,col='model')) +
  geom_point(aes(x=prior,col='prior'))

# expected EVs roughly match the stochastic simulations?
final_states <- enframe(mu_b_prior,'state','prior') %>%
  left_join(df %>%
              filter(t > (max(t)-14),) %>%
              group_by(state) %>%
              summarise(poll = weighted.mean(p_clinton,n_respondents))) %>%
  mutate(avg_poll_less_prior = mean(poll - inv.logit(prior), na.rm=T)) %>%
  mutate(poll = ifelse(is.na(poll),
                       inv.logit(prior) + avg_poll_less_prior,
                       poll)) %>%
  select(state,poll)

# final EV distribution
final_evs <- draws %>%
  left_join(state_elec_results %>% select(state,ev),by='state') %>%
  filter(t==max(t)) %>%
  group_by(draw) %>%
  summarise(dem_ev = sum(ev* (p_clinton > 0.5)))

final_evs.2016.gg <-  ggplot(final_evs,aes(x=dem_ev,
                       fill=ifelse(dem_ev>=270,'Democratic','Republican'))) +
    geom_vline(xintercept = 270) +
    geom_histogram(binwidth=1) +
    theme_minimal() +
    theme(legend.position = 'top',
          panel.grid.minor = element_blank()) +
    scale_fill_manual(name='Electoral College winner',values=c('Democratic'='#3A4EB1','Republican'='#E40A04')) +
    labs(x='Democratic electoral college votes',title='2016, Potential Electoral College outcomes',
         subtitle=sprintf("p(dem win) = %s | full stan model",round(mean(final_evs$dem_ev>=270),3)))


```


#### Map

```{r echo=F,message=F,warning=F}
map.2016.gg
```

#### Final electoral college histogram

```{r echo=F,message=F,warning=F}
final_evs.2016.gg
```

#### National and state polls and the electoral college over time

```{r echo=F,message=F,warning=F,fig.width = 9, fig.asp = .62}
grid.arrange(natl_polls.2016.gg, natl_evs.2016.gg, state_polls.2016.gg, 
             layout_matrix = rbind(c(1,1,3,3,3),
                                   c(2,2,3,3,3)),
             top = identifier
)
```

#### State vs national deltas over time

```{r echo=F,message=F,warning=F}
state_lean.2016.gg
```

#### Model results vs polls vs the prior

```{r echo=F,message=F,warning=F}
predictcompare.2016.gg
```

#### Performance

````{r echo=F,message=F,warning=F}
knitr::kable(briers.2016)
```

#### Predictions for each state

```{r echo=F,message=F,warning=F}
p_clinton %>% 
  filter(t == max(t)) %>% 
  mutate(se = (high - mean)/2) %>%
  mutate(high = round(high,3),
         low = round(low,3),
         mean = round(mean,3),
         prob = round(prob,3),
         se = round(se,3)) %>%
  select(state,mean,low,high,prob,se) %>%
  arrange(abs(mean-0.5)) %>%
  datatable()
            
```

